{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ìŠ¤í† ë¦¬</title>
    <link rel="icon" href="/static/imagestory.ico">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script type="text/javascript" src="{% static 'jquery.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <style>
        .svg-icon {
            width: 1.5em;
            height: 1.5em;
            transition: 1s;
        }
    </style>
</head>

<script>
var image_change = false;

window.onload = function(){
    var filesInput = document.getElementById("id_image");
    filesInput.addEventListener("change", function(event){
        image_change = true;
    });
}

//ì´ë¯¸ì§€ ë³€ê²½ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ë³€ê²½ë˜ì—ˆìœ¼ë©´ ìˆ˜ì •í•˜ëŠ” ê²ƒ í™•ì¸í›„ ì‹¤í–‰
function check_image_change(){
    if ((image_change || document.getElementById("image-clear_id").checked) && !(document.getElementById("layer_save").checked)){
        a = confirm("ì´ë¯¸ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•´ë‹¹ ì´ë¯¸ì§€ì— ìˆëŠ” ëª¨ë“  ë ˆì´ì–´ ì •ë³´ëŠ” ì‚­ì œë©ë‹ˆë‹¤!\nì •ë§ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        if (a){
            // document.information_data.submit();
            upload_and_progress();
            return false;
        }else{
            return false;
        }
    } else {
        upload_and_progress();
        return false;
    }
}
</script>
<!-- notice ajax ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
{% include "notice_ajax.html" %}
<body>
    <div class="container-fluid p-0">
        {% include 'navbar.html' %}
        <div class="text-center"><a class="btn btn-info" href="{% url 'board:detail' board_name get_board.id %}">ë’¤ë¡œê°€ê¸°</a></div>
        <div class="container">
            <form onsubmit="check_image_change(); return false;" enctype="multipart/form-data" style='display:block;' id='information_data' action="{% url 'board:root_modify' get_board.category get_board.id %}" method='post' name='information_data'>
                {% csrf_token %}
                <div class="m-3 text-center"><strong>â™»ê²Œì‹œê¸€ ìˆ˜ì •</strong></div>
                <div class="m-2">{{boardform.title}}</div>
                <div class="m-2">{{boardform.information}}</div>
                <div class="m-3"><b>ğŸ–¼ì´ë¯¸ì§€</b> : <br>{{boardform.image}}</div>
                <div class="m-3 text-center">ì¤‘ìš”ë„ : {{boardform.important}}</div>
                <div class="m-3 text-center">ê³µê°œì—¬ë¶€ : {{boardform.secure}}</div>
                {{boardform.cord_sx}}
                {{boardform.cord_sy}}
                {{boardform.cord_lx}}
                {{boardform.cord_ly}}
                <div class="text-center" style="border: 1px black solid; width: fit-content; margin:auto; padding:10px;">
                    <p><b>ì‚¬ì§„ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ê²½ìš°<br>ë§Œì•½ í˜„ì¬ ìˆ˜ì •í•˜ë ¤ëŠ” ì‚¬ì§„ ì•ˆì— ìˆëŠ” <span style="color: red;">ì˜ì—­ì˜ ì •ë³´ê°€ ì „ë¶€ ì‚­ì œ</span>ë©ë‹ˆë‹¤!</b></p>
                    <p>
                        <span style="color: blue;font-weight: bold;">ì‚¬ì§„ ìˆ˜ì • ì‹œ ì˜ì—­ì •ë³´ ë‚¨ê¸°ê¸° : </span><input id="layer_save" type="checkbox" name="layer_save"/><br>
                        ë‹¨, ì‚¬ì§„ì˜ í•´ìƒë„ë¥¼ ê³ ë ¤í•˜ì—¬ ì‚¬ì§„ì„ ìˆ˜ì •í•˜ì„¸ìš”!<br>í•´ìƒë„ê°€ ì‘ì•„ì§€ë©´ ì˜ì—­ì´ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                    </p>
                </div><br>
                <div class="text-center mb-5"><input class="btn btn-success" type='submit' value='ìˆ˜ì •í•˜ê¸°'></div>
            </form>
        </div>
    </div>

<!-- í”„ë¡œê·¸ë˜ìŠ¤ë°” Modal -->
<div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">ì—…ë¡œë“œ ì¤‘</h5>
        </div>
        <div class="modal-body">
            <div class="progress">
                <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated active" role="progressbar"
                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
                  0%
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- í”„ë¡œê·¸ë˜ìŠ¤ë°” ë³´ì´ë„ë¡ ì„¤ì • -->
<script>
    function upload_and_progress(){
        $('#staticBackdrop').modal({
            show: true,
        });
        // í¼
        const uploadForm = document.getElementById("information_data");
        // ì´ë¯¸ì§€
        const inputImage = document.getElementById("id_image");
        // csrf
        const csrf = document.getElementsByName("csrfmiddlewaretoken");
        // title
        const title = document.getElementById("id_title");
        // information
        const information = document.getElementById("id_information");
        // secure
        const secure = document.getElementById("id_secure");

        const progress_bar = document.getElementById("progress_bar");

        // ìƒˆë¡œìš´ í¼ ìƒì„±
        const fd = new FormData();
        // ê·¸ í›„, ì§ì ‘ ì•ˆì— í•´ë‹¹ ê°’ ë„£ê¸°
        fd.append('csrfmiddlewaretoken', csrf[0].value);
        fd.append('title', title.value);
        fd.append('information', information.value);
        fd.append('secure', secure.value);
        

        // ì´ë¯¸ì§€ë¥¼ ì„ íƒí–ˆì„ ê²½ìš° ë° ì´ë¯¸ì§€ê°€ ê¸°ì¡´ì— ìˆì„ ê²½ìš°
        if (inputImage.files[0] || document.getElementById("image-clear_id")){
            // layer ë¥¼ ìˆ˜ì •í•  ê²ƒì¸ê°€ë¥¼ ê°€ì§€ê³  ìˆë‹¤
            const layer_save = document.getElementById("layer_save");
            
            image_data = inputImage.files[0];
            fd.append('image', image_data);
            fd.append('layer_save', layer_save.checked);

            // ê¸°ì¡´ì— ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš°
            if (document.getElementById("image-clear_id")){
                const image_clear = document.getElementById("image-clear_id")
                fd.append('image-clear', image_clear.checked);
            }
            // ì¢Œí‘œë¥¼ ê°€ì§€ê³  ìˆì„ ê²½ìš°
            if (document.getElementById("id_important")){
                const cord_sx = document.getElementById("id_cord_sx");
                const cord_sy = document.getElementById("id_cord_sy");
                const cord_lx = document.getElementById("id_cord_lx");
                const cord_ly = document.getElementById("id_cord_ly");
                const important = document.getElementById("id_important");
                fd.append('important', important.value);
                fd.append('cord_sx', cord_sx.value);
                fd.append('cord_sy', cord_sy.value);
                fd.append('cord_lx', cord_lx.value);
                fd.append('cord_ly', cord_ly.value);
            }
        }

        // í”„ë¡œê·¸ë˜ìŠ¤ ë°” ë³´ì´ë„ë¡ ajax í•´ë²„ë¦¬ê¸°
        $.ajax({
            type: "POST",
            url: uploadForm.action,
            enctype:"multipart/form-data",
            data: fd,
            // ë³´ë‚´ê¸° ì „ì— í•˜ëŠ” ì¼
            beforeSend: function() {

            },
            // í”„ë¡œê·¸ë˜ìŠ¤ ì¼
            xhr: function(){
                const xhr = new XMLHttpRequest();
                // ì§„í–‰ ì¤‘ì¼ ê²½ìš° xhrë¥¼ return í•œë‹¤
                xhr.upload.addEventListener('progress', e => {
                    if (e.lengthComputable){
                        const percent = e.loaded / e.total * 100;
                        progress_bar.style.width = String(parseInt(percent)) + "%";
                        progress_bar.innerHTML = String(parseInt(percent)) + "%";
                        if (parseInt(percent) ===  100){
                            document.getElementById("staticBackdropLabel").innerHTML = "ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!<br>ì´ë¯¸ì§€ë¥¼ ë³€í™˜ ì¤‘ ì…ë‹ˆë‹¤!<br>ì´ë¯¸ì§€ í¬ê¸°ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤!";
                            progress_bar.innerHTML = "ì—…ë¡œë“œì¤‘...";
                        }
                    }
                });
                return xhr
            },
            // ì„±ê³µ í–ˆì„ ê²½ìš°
            success: function(response){
                console.log(response);
                if (response["message"] == 'error'){
                    console.log(response["message"]);
                } else{
                    location.href=response["message"];
                }
            },
            // ì—ëŸ¬ ë‚¬ì„ ê²½ìš°
            error: function(error){
                console.log(error);
            },
            cache: false,
            contentType: false,
            processData: false,
        });
    }
</script>
</body>
</html>