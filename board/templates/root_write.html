{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ìŠ¤í† ë¦¬</title>
    <link rel="icon" href="/static/imagestory.ico">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script type="text/javascript" src="{% static 'jquery.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <style>
        .svg-icon {
            width: 1.5em;
            height: 1.5em;
            transition: 1s;
        }
    </style>
</head>
<!-- notice ajax ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
{% include "notice_ajax.html" %}
<body>

<div class="container-fluid p-0">
    {% include 'navbar.html' %}
    <div style="text-align: center;"><a class="btn btn-info" href="{% url 'board:main' board_name %}">ë’¤ë¡œê°€ê¸°</a></div>
    <div class="container">
        <form enctype="multipart/form-data" id='information_data' action='{% url "board:root_write" board_name %}' method="POST" name='information_data' onsubmit="upload_and_progress(); return false;">
            {% csrf_token %}
            <div class="m-3 text-center"><strong>ğŸ“‘ê²Œì‹œê¸€ ì‘ì„±</strong></div>
            <div class="m-2">{{boardform.title}}</div>
            <div class="m-2">{{boardform.information}}</div>
            <div class="m-3"><b>ğŸ–¼ì´ë¯¸ì§€ ì¶”ê°€</b> : <br>{{boardform.image}}</div>
            <div class="m-3 text-center">ê³µê°œì—¬ë¶€ : {{boardform.secure}}</div>
            <div class="m-4 text-center"><input class="btn btn-success" type='submit' value='ê¸€ì“°ê¸°'/></div>
            <!-- ë‚˜ì¤‘ì— ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ì—¬ì£¼ê¸° ì €ì¥ -->
        </form>
    </div>
    <!-- <button onclick="upload_and_progress();">ì´ê±°ëŠ”?</button> -->
</div>

<br>
  
<!-- í”„ë¡œê·¸ë˜ìŠ¤ë°” Modal -->
<div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">ì—…ë¡œë“œ ì¤‘</h5>
    </div>
    <div class="modal-body">
        <div class="progress">
            <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated active" role="progressbar"
            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
              0%
            </div>
        </div>
    </div>
    </div>
</div>
</div>

<!-- í”„ë¡œê·¸ë˜ìŠ¤ë°” ë³´ì´ë„ë¡ ì„¤ì • -->
<script>
    function upload_and_progress(){
        $('#staticBackdrop').modal({
            show: true,
        });
        // í¼
        const uploadForm = document.getElementById("information_data");
        // ì´ë¯¸ì§€
        const inputImage = document.getElementById("id_image");
        // csrf
        const csrf = document.getElementsByName("csrfmiddlewaretoken");
        // title
        const title = document.getElementById("id_title");
        // information
        const information = document.getElementById("id_information");
        // secure
        const secure = document.getElementById("id_secure");

        const progress_bar = document.getElementById("progress_bar");

        // ìƒˆë¡œìš´ í¼ ìƒì„±
        const fd = new FormData();
        // ê·¸ í›„, ì§ì ‘ ì•ˆì— í•´ë‹¹ ê°’ ë„£ê¸°
        fd.append('csrfmiddlewaretoken', csrf[0].value);
        fd.append('title', title.value);
        fd.append('information', information.value);
        fd.append('secure', secure.value);

        // í”„ë¡œê·¸ë˜ìŠ¤ ë°” ë³´ì´ë„ë¡ ajax í•´ë²„ë¦¬ê¸°
        if (inputImage.files[0]){
            image_data = inputImage.files[0];
            fd.append('image', image_data);
        }

        $.ajax({
            type: "POST",
            url: uploadForm.action,
            enctype:"multipart/form-data",
            data: fd,
            // ë³´ë‚´ê¸° ì „ì— í•˜ëŠ” ì¼
            beforeSend: function() {

            },
            // í”„ë¡œê·¸ë˜ìŠ¤ ì¼
            xhr: function(){
                const xhr = new XMLHttpRequest();
                // ì§„í–‰ ì¤‘ì¼ ê²½ìš° xhrë¥¼ return í•œë‹¤
                xhr.upload.addEventListener('progress', e => {
                    if (e.lengthComputable){
                        const percent = e.loaded / e.total * 100;
                        progress_bar.style.width = String(parseInt(percent)) + "%";
                        progress_bar.innerHTML = String(parseInt(percent)) + "%";
                        if (parseInt(percent) ===  100){
                            document.getElementById("staticBackdropLabel").innerHTML = "ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!<br>ì´ë¯¸ì§€ë¥¼ ë³€í™˜ ì¤‘ ì…ë‹ˆë‹¤!<br>ì´ë¯¸ì§€ í¬ê¸°ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤!";
                            progress_bar.innerHTML = "ì—…ë¡œë“œì¤‘...";
                        }
                    }
                });
                return xhr
            },
            // ì„±ê³µ í–ˆì„ ê²½ìš°
            success: function(response){
                console.log(response);
                if (response["message"] == 'error'){
                    console.log(response["message"]);
                } else{
                    location.href=response["message"];
                }
            },
            // ì—ëŸ¬ ë‚¬ì„ ê²½ìš°
            error: function(error){
                console.log(error);
            },
            cache: false,
            contentType: false,
            processData: false,
        });
    }
</script>
</body>
</html>